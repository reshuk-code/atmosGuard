<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AtmosGuard</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/profile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* Dashboard enhancements */
        .dashboard-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        @media (max-width: 1024px) {
            .dashboard-main {
                grid-template-columns: 1fr;
            }
        }

        /* Welcome Card */
        .welcome-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            grid-column: 1 / -1;
        }

        .welcome-content h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .welcome-content p {
            opacity: 0.9;
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* UV Index Card */
        .uv-card-enhanced {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .uv-visual {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin: 1.5rem 0;
        }

        .uv-gauge {
            width: 150px;
            height: 150px;
            position: relative;
        }

        .gauge-background {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                    #10b981 0% 16%,
                    #f59e0b 16% 41%,
                    #f97316 41% 58%,
                    #ef4444 58% 83%,
                    #7f1d1d 83% 100%
            );
            position: relative;
        }

        .gauge-inner {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .uv-index-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .uv-level-text {
            font-size: 1rem;
            color: #6b7280;
        }

        .protection-tips {
            margin-top: 1.5rem;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .tip-item i {
            color: #4f46e5;
        }

        /* Weather & Air Quality */
        .weather-aqi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        @media (max-width: 768px) {
            .weather-aqi-grid {
                grid-template-columns: 1fr;
            }
        }

        .weather-card, .aqi-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .weather-header, .aqi-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .weather-header i, .aqi-header i {
            font-size: 1.25rem;
            color: #4f46e5;
        }

        .weather-info, .aqi-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .temperature {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .weather-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        /* Recommendations Card */
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .recommendation-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .recommendation-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .recommendation-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .recommendation-content h4 {
            margin: 0 0 0.25rem;
            font-size: 0.875rem;
            color: #1f2937;
        }

        .recommendation-content p {
            margin: 0;
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* Profile Summary Card */
        .profile-summary-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .profile-stat {
            text-align: center;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 10px;
        }

        .profile-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4f46e5;
            margin-bottom: 0.25rem;
        }

        .profile-stat-label {
            font-size: 0.75rem;
            color: #6b7280;
        }
    </style>
    <!-- Add this CSS in the style section -->
    <style>
        /* AI Recommendations Section */
        .ai-recommendations-section {
            margin-top: 2rem;
        }

        .recommendations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .recommendations-header h3 {
            font-size: 1.5rem;
            color: #1f2937;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-powered-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .recommendation-category {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s;
        }

        .recommendation-category:hover {
            transform: translateY(-5px);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f3f4f6;
        }

        .category-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .category-title h4 {
            margin: 0 0 5px;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .category-title p {
            margin: 0;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .recommendation-item:last-child {
            border-bottom: none;
        }

        .item-check {
            color: #10b981;
            font-size: 0.875rem;
            margin-top: 2px;
        }

        .item-text {
            flex: 1;
            color: #374151;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .recommendation-images {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .recommendation-image {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .recommendation-image:hover {
            transform: scale(1.05);
        }

        .overall-advice {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-left: 4px solid #0ea5e9;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 2rem;
        }

        .overall-advice h4 {
            margin: 0 0 0.75rem;
            color: #0369a1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .overall-advice p {
            margin: 0;
            color: #0c4a6e;
            line-height: 1.6;
        }

        .special-considerations {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
        }

        .special-considerations h4 {
            margin: 0 0 0.75rem;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .special-considerations ul {
            margin: 0;
            padding-left: 1.5rem;
            color: #92400e;
        }

        .special-considerations li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        /* Refresh button */
        .refresh-recommendations {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 0.5rem 1rem;
            background: white;
            border: 2px solid #4f46e5;
            color: #4f46e5;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-recommendations:hover {
            background: #4f46e5;
            color: white;
        }

        /* Image modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .image-modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .modal-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .image-caption {
            color: white;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar">
    <div class="container">
        <div class="logo">
            <i class="fas fa-shield-alt"></i>
            <span>AtmosGuard</span>
        </div>
        <div class="nav-links" id="navLinks">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</nav>

<!-- Dashboard Container -->
<div class="dashboard-container">
    <div class="container">
        <!-- Welcome Card -->
        <div class="welcome-card">
            <div class="welcome-content">
                <h1 id="greeting">Good morning, <%= user.name %>!</h1>
                <p id="dashboardSummary">Here's your personalized sun protection overview for today.</p>
                <div class="quick-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="uvIndexValue">--</div>
                        <div class="stat-label">UV Index</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="temperatureValue">--°C</div>
                        <div class="stat-label">Temperature</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="aqiValue">--</div>
                        <div class="stat-label">Air Quality</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="protectionScore">--%</div>
                        <div class="stat-label">Protection Score</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-main">
            <!-- Left Column -->
            <div class="dashboard-left">
                <!-- UV Index Card -->
                <div class="uv-card-enhanced">
                    <div class="card-header">
                        <h3><i class="fas fa-sun"></i> UV Index Today</h3>
                        <span class="last-updated" id="uvLastUpdated">Updated just now</span>
                    </div>

                    <div class="uv-visual">
                        <div class="uv-gauge">
                            <div class="gauge-background"></div>
                            <div class="gauge-inner">
                                <div class="uv-index-display" id="uvIndexDisplay">--</div>
                                <div class="uv-level-text" id="uvLevelText">Loading...</div>
                            </div>
                        </div>
                        <div class="uv-info">
                            <div class="risk-level">
                                <span class="risk-badge" id="riskBadge">Moderate</span>
                                <p id="riskDescription">Moderate risk from UV rays</p>
                            </div>
                            <div class="protection-tips" id="protectionTips">
                                <!-- Tips will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <div class="weather-aqi-grid">
                        <div class="weather-card">
                            <div class="weather-header">
                                <i class="fas fa-thermometer-half"></i>
                                <h4>Weather</h4>
                            </div>
                            <div class="weather-info">
                                <div class="temperature" id="temperatureDisplay">--°C</div>
                                <div class="weather-details">
                                    <div class="detail">
                                        <i class="fas fa-tint"></i>
                                        <span>Humidity: <strong id="humidityValue">--%</strong></span>
                                    </div>
                                    <div class="detail">
                                        <i class="fas fa-wind"></i>
                                        <span>Wind: <strong id="windSpeed">-- km/h</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="aqi-card">
                            <div class="aqi-header">
                                <i class="fas fa-wind"></i>
                                <h4>Air Quality</h4>
                            </div>
                            <div class="aqi-info">
                                <div class="aqi-value-circle">
                                    <div class="aqi-value" id="aqiValueDisplay">--</div>
                                    <div class="aqi-level" id="aqiLevelDisplay">--</div>
                                </div>
                                <div class="aqi-details">
                                    <p id="aqiDescription">Air quality is satisfactory</p>
                                    <div class="pollutants">
                                        <span>PM2.5: <strong id="pm25Value">--</strong></span>
                                        <span>O₃: <strong id="o3Value">--</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="uv-card-enhanced">


                    <div class="recommendations-grid" id="recommendationsGrid">
                        <!-- AI Clothing Recommendations -->
                        <div class="ai-recommendations-section">
                            <div class="recommendations-header">
                                <h3>
                                    <i class="fas fa-tshirt"></i>
                                    Today's Clothing Recommendations
                                    <span class="ai-powered-badge">
                <i class="fas fa-robot"></i> AI-Powered
            </span>
                                </h3>
                                <button class="refresh-recommendations" onclick="refreshAIRecommendations()">
                                    <i class="fas fa-sync-alt"></i> Refresh Recommendations
                                </button>
                            </div>

                            <div id="aiRecommendations">
                                <div class="loading-recommendations" style="text-align: center; padding: 3rem;">
                                    <div class="loader" style="width: 50px; height: 50px; margin: 0 auto 1rem;"></div>
                                    <p>Generating your personalized recommendations...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Image Modal -->
                        <div class="image-modal" id="imageModal">
                            <div class="modal-content">
                                <button class="modal-close" onclick="closeImageModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                                <img class="modal-image" id="modalImage" src="" alt="">
                                <div class="image-caption" id="imageCaption"></div>
                            </div>
                        </div>

                        <!-- Image Modal -->
                        <div class="image-modal" id="imageModal">
                            <div class="modal-content">
                                <button class="modal-close" onclick="closeImageModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                                <img class="modal-image" id="modalImage" src="" alt="">
                                <div class="image-caption" id="imageCaption"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="dashboard-right">
                <!-- Profile Summary -->
                <div class="profile-summary-card">
                    <div class="card-header">
                        <h3><i class="fas fa-user-circle"></i> Your Profile</h3>
                        <a href="/profile" class="edit-btn">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                    </div>

                    <div class="profile-info">
                        <div class="info-item">
                            <span class="label">Skin Type</span>
                            <span class="value" id="profileSkinType">
                                <%= user.skinType || 'Not set' %>
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="label">Age</span>
                            <span class="value" id="profileAge">
                                <%= user.age ? user.age + ' years' : 'Not set' %>
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="label">Condition</span>
                            <span class="value" id="profileCondition">
                                <%= user.skinCondition ?
                                        user.skinCondition.charAt(0).toUpperCase() + user.skinCondition.slice(1) :
                                        'Not set'
                                %>
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="label">Cancer History</span>
                            <span class="value" id="profileCancerHistory">
                                <%= user.hasSkinCancerHistory ? 'Yes' : 'No' %>
                            </span>
                        </div>
                        <div class="info-item">
                            <span class="label">Location</span>
                            <span class="value" id="profileLocation">
                                <%= user.preferredLocation ? user.preferredLocation.name : 'Not set' %>
                            </span>
                        </div>
                    </div>

                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="statDays">0</div>
                            <div class="profile-stat-label">Days Protected</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="statAdvice">0</div>
                            <div class="profile-stat-label">Advice Received</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="statAlerts">0</div>
                            <div class="profile-stat-label">UV Alerts</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="uv-card-enhanced">
                    <div class="card-header">
                        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                    </div>

                    <div class="quick-actions-grid">
                        <a href="/api/ai/advice" class="action-card">
                            <div class="action-icon">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="action-content">
                                <h4>Get AI Advice</h4>
                                <p>Personalized protection plan</p>
                            </div>
                        </a>

                        <a href="#" class="action-card" onclick="printPlan()">
                            <div class="action-icon">
                                <i class="fas fa-print"></i>
                            </div>
                            <div class="action-content">
                                <h4>Print Plan</h4>
                                <p>Printable protection guide</p>
                            </div>
                        </a>

                        <a href="/profile" class="action-card">
                            <div class="action-icon">
                                <i class="fas fa-user-edit"></i>
                            </div>
                            <div class="action-content">
                                <h4>Edit Profile</h4>
                                <p>Update your information</p>
                            </div>
                        </a>

                        <a href="#" class="action-card" onclick="sharePlan()">
                            <div class="action-icon">
                                <i class="fas fa-share-alt"></i>
                            </div>
                            <div class="action-content">
                                <h4>Share Plan</h4>
                                <p>Share with family/friends</p>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- Daily Tips -->
                <div class="uv-card-enhanced">
                    <div class="card-header">
                        <h3><i class="fas fa-lightbulb"></i> Daily Tips</h3>
                    </div>

                    <div class="daily-tips" id="dailyTips">
                        <!-- Tips will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Update greeting based on time
    function updateGreeting() {
        const hour = new Date().getHours();
        let greeting = '';

        if (hour < 12) greeting = 'Good morning';
        else if (hour < 18) greeting = 'Good afternoon';
        else greeting = 'Good evening';

        document.getElementById('greeting').textContent = `${greeting}, <%= user.name %>!`;
    }

    // Load dashboard data
    async function loadDashboardData() {
        try {
            showLoading(true);

            const response = await fetch('/api/dashboard', {
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success) {
                updateDashboardUI(data.data);
            } else {
                console.error('Failed to load dashboard data:', data.message);
                showError('Failed to load dashboard data. Please try again.');
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
            showError('Network error. Please check your connection.');
        } finally {
            showLoading(false);
        }
    }

    function updateDashboardUI(data) {
        // Update UV Index
        if (data.uv) {
            document.getElementById('uvIndexValue').textContent = data.uv.index;
            document.getElementById('uvIndexDisplay').textContent = data.uv.index;
            document.getElementById('uvLevelText').textContent = data.uv.level;
            document.getElementById('riskBadge').textContent = data.uv.level;
            document.getElementById('riskBadge').className = `risk-badge ${data.uv.level.toLowerCase().replace(' ', '-')}`;
            document.getElementById('riskDescription').textContent = data.uv.risk;

            // Update protection tips
            const tipsContainer = document.getElementById('protectionTips');
            tipsContainer.innerHTML = '';
            if (data.uv.protectionAdvice && data.uv.protectionAdvice.length > 0) {
                data.uv.protectionAdvice.slice(0, 3).forEach(tip => {
                    const tipElement = document.createElement('div');
                    tipElement.className = 'tip-item';
                    tipElement.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <span>${tip}</span>
                    `;
                    tipsContainer.appendChild(tipElement);
                });
            }
        }

        // Update weather
        if (data.weather) {
            document.getElementById('temperatureValue').textContent = `${data.weather.temperature}°C`;
            document.getElementById('temperatureDisplay').textContent = `${data.weather.temperature}°C`;
            document.getElementById('humidityValue').textContent = `${data.weather.humidity}%`;
            document.getElementById('windSpeed').textContent = `${data.weather.windSpeed} km/h`;
        }

        // Update AQI
        if (data.airQuality) {
            document.getElementById('aqiValue').textContent = data.airQuality.aqi;
            document.getElementById('aqiValueDisplay').textContent = data.airQuality.aqi;
            document.getElementById('aqiLevelDisplay').textContent = data.airQuality.aqiDescription.level;
            document.getElementById('aqiDescription').textContent = data.airQuality.aqiDescription.description;

            if (data.airQuality.components) {
                document.getElementById('pm25Value').textContent = data.airQuality.components.pm2_5 || '--';
                document.getElementById('o3Value').textContent = data.airQuality.components.o3 || '--';
            }
        }

        // Update recommendations
        if (data.recommendations) {
            updateRecommendations(data.recommendations);
        }

        // Update stats
        if (data.stats) {
            document.getElementById('statDays').textContent = data.stats.daysProtected || 0;
            document.getElementById('statAdvice').textContent = data.stats.adviceReceived || 0;
            document.getElementById('statAlerts').textContent = data.stats.uvAlerts || 0;
            document.getElementById('protectionScore').textContent = data.stats.protectionScore || '--%';
        }

        // Update daily tips
        if (data.dailyTips) {
            updateDailyTips(data.dailyTips);
        }

        // Update last updated time
        document.getElementById('uvLastUpdated').textContent = `Updated ${formatTime(new Date())}`;
    }

    function updateRecommendations(recommendations) {
        const grid = document.getElementById('recommendationsGrid');
        grid.innerHTML = '';

        // Create recommendation items for each category
        const categories = [
            { key: 'head', icon: 'fas fa-hat-cowboy', title: 'Head Protection' },
            { key: 'upperBody', icon: 'fas fa-tshirt', title: 'Upper Body' },
            { key: 'lowerBody', icon: 'fas fa-vest', title: 'Lower Body' },
            { key: 'sunscreen', icon: 'fas fa-sun', title: 'Sunscreen' },
            { key: 'accessories', icon: 'fas fa-glasses', title: 'Accessories' },
            { key: 'timing', icon: 'fas fa-clock', title: 'Timing' }
        ];

        categories.forEach(category => {
            if (recommendations[category.key] && recommendations[category.key].length > 0) {
                const item = document.createElement('div');
                item.className = 'recommendation-item';
                item.innerHTML = `
                    <div class="recommendation-icon">
                        <i class="${category.icon}"></i>
                    </div>
                    <div class="recommendation-content">
                        <h4>${category.title}</h4>
                        <p>${recommendations[category.key][0]}</p>
                    </div>
                `;
                grid.appendChild(item);
            }
        });
    }

    function updateDailyTips(tips) {
        const container = document.getElementById('dailyTips');
        container.innerHTML = '';

        tips.slice(0, 3).forEach(tip => {
            const tipElement = document.createElement('div');
            tipElement.className = 'tip-item';
            tipElement.innerHTML = `
                <i class="fas fa-lightbulb"></i>
                <span>${tip}</span>
            `;
            container.appendChild(tipElement);
        });
    }

    function formatTime(date) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function showLoading(show) {
        // Implement loading overlay if needed
    }

    function showError(message) {
        // Show error message to user
        alert(message);
    }

    function refreshRecommendations() {
        loadDashboardData();
    }

    function printPlan() {
        window.print();
    }

    function sharePlan() {
        // Implement share functionality
        alert('Share functionality coming soon!');
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
        updateGreeting();
        loadDashboardData();

        // Auto-refresh every 30 minutes
        setInterval(loadDashboardData, 30 * 60 * 1000);

        // Setup navigation
        setupNavigation();
    });

    // Setup navigation
    function setupNavigation() {
        const navLinks = document.getElementById('navLinks');
        navLinks.innerHTML = `
            <a href="/dashboard" class="active">Dashboard</a>
            <a href="/profile">Profile</a>
            <a href="/ai-advice">AI Advice</a>
            <div class="user-dropdown">
                <button class="user-menu-btn">
                    <i class="fas fa-user-circle"></i>
                    <span><%= user.name %></span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu">
                    <a href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    <a href="/profile"><i class="fas fa-user"></i> Profile</a>
                    <div class="dropdown-divider"></div>
                    <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        `;

        // Setup dropdown
        const userMenuBtn = document.querySelector('.user-menu-btn');
        const dropdownMenu = document.querySelector('.dropdown-menu');

        if (userMenuBtn && dropdownMenu) {
            userMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdownMenu.classList.toggle('show');
            });

            document.addEventListener('click', (e) => {
                if (!userMenuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });

            // Setup logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();

                    try {
                        const response = await fetch('/api/auth/logout', {
                            method: 'POST',
                            credentials: 'include'
                        });

                        const data = await response.json();
                        if (data.success) {
                            localStorage.removeItem('user');
                            window.location.href = '/';
                        }
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                });
            }
        }
    }
    // Function to refresh AI recommendations
    async function refreshAIRecommendations() {
        const refreshButton = document.querySelector('.refresh-recommendations');
        if (!refreshButton) return;

        try {
            // Update button to show loading state
            refreshButton.innerHTML = `
            <i class="fas fa-spinner fa-spin"></i> Refreshing...
        `;
            refreshButton.disabled = true;

            const response = await fetch('/api/dashboard/refresh-recommendations', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success && data.recommendations) {
                updateAIRecommendations(data.recommendations);
                showNotification('AI recommendations refreshed successfully!', 'success');
            } else {
                // Handle known error from server
                const errorMsg = data.message || 'Failed to refresh recommendations.';
                updateAIRecommendations(null); // Show "unavailable" state
                showNotification(errorMsg, 'error');
            }
        } catch (error) {
            console.error('Error refreshing AI recommendations:', error);
            updateAIRecommendations(null);
            showNotification('Network error. Please check your connection and try again.', 'error');
        } finally {
            // Always restore the button state
            refreshButton.innerHTML = `
            <i class="fas fa-sync-alt"></i> Refresh Recommendations
        `;
            refreshButton.disabled = false;
        }
    }
    // Function to refresh AI recommendations
    async function refreshAIRecommendations() {
        const refreshButton = document.querySelector('.refresh-recommendations');
        if (!refreshButton) return;

        try {
            // Update button to loading state
            refreshButton.innerHTML = `
            <i class="fas fa-spinner fa-spin"></i> Refreshing...
        `;
            refreshButton.disabled = true;

            const response = await fetch('/api/dashboard/refresh-recommendations', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success && data.recommendations) {
                updateAIRecommendations(data.recommendations);
                showNotification('Recommendations refreshed successfully!', 'success');
            } else {
                const errorMsg = data.message || 'Failed to refresh recommendations.';
                updateAIRecommendations(null);
                showNotification(errorMsg, 'error');
            }
        } catch (error) {
            console.error('Error refreshing AI recommendations:', error);
            updateAIRecommendations(null);
            showNotification('Network error. Please try again.', 'error');
        } finally {
            // Restore button
            refreshButton.innerHTML = `
            <i class="fas fa-sync-alt"></i> Refresh Recommendations
        `;
            refreshButton.disabled = false;
        }
    }

    // Function to update AI recommendations in UI
    function updateAIRecommendations(recommendations) {
        const container = document.getElementById('aiRecommendations');

        if (!recommendations || Object.keys(recommendations).length === 0) {
            container.innerHTML = `
            <div class="error-message" style="text-align: center; padding: 3rem;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f59e0b; margin-bottom: 1rem;"></i>
                <h3 style="color: #1f2937; margin-bottom: 1rem;">Recommendations Unavailable</h3>
                <p style="color: #6b7280;">Unable to generate AI recommendations at the moment.</p>
            </div>
        `;
            return;
        }

        let html = `<div class="recommendations-grid">`;

        // Define categories with icons and titles
        const categories = [
            { key: 'headwear', icon: 'fa-hat-cowboy', title: 'Headwear', desc: 'Protect your head and face' },
            { key: 'upperBody', icon: 'fa-tshirt', title: 'Upper Body', desc: 'Shirts, jackets, and tops' },
            { key: 'lowerBody', icon: 'fa-vest', title: 'Lower Body', desc: 'Pants, shorts, and skirts' },
            { key: 'footwear', icon: 'fa-shoe-prints', title: 'Footwear', desc: 'Shoes and socks' },
            { key: 'accessories', icon: 'fa-glasses', title: 'Accessories', desc: 'Sunglasses, masks, and more' }
        ];

        categories.forEach(cat => {
            const items = recommendations[cat.key];
            const images = recommendations[`${cat.key}Images`];

            if (items && items.length > 0) {
                html += `
                <div class="recommendation-category">
                    <div class="category-header">
                        <div class="category-icon">
                            <i class="fas ${cat.icon}"></i>
                        </div>
                        <div class="category-title">
                            <h4>${cat.title}</h4>
                            <p>${cat.desc}</p>
                        </div>
                    </div>
                    <div class="category-content">
                        ${items.map(item => `
                            <div class="recommendation-item">
                                <i class="fas fa-check item-check"></i>
                                <span class="item-text">${item}</span>
                            </div>
                        `).join('')}
                    </div>
                    ${images && images.length > 0 ? `
                        <div class="recommendation-images">
                            ${images.map(img => `
                                <img src="${img.url}"
                                     alt="${img.alt || cat.title}"
                                     class="recommendation-image"
                                     onclick="openImageModal('${img.url}', '${img.alt || cat.title}', '${img.photographer || 'Unsplash'}')">
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            }
        });

        html += `</div>`;

        // Overall Advice
        if (recommendations.overallAdvice) {
            html += `
            <div class="overall-advice">
                <h4><i class="fas fa-lightbulb"></i> Today's Advice</h4>
                <p>${recommendations.overallAdvice}</p>
            </div>
        `;
        }

        // Special Considerations
        if (recommendations.specialConsiderations && recommendations.specialConsiderations.length > 0) {
            html += `
            <div class="special-considerations">
                <h4><i class="fas fa-exclamation-triangle"></i> Special Considerations</h4>
                <ul>
                    ${recommendations.specialConsiderations.map(item => `<li>${item}</li>`).join('')}
                </ul>
            </div>
        `;
        }

        container.innerHTML = html;
    }

    // Image Modal Functions
    function openImageModal(url, alt, photographer) {
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const caption = document.getElementById('imageCaption');

        modalImage.src = url;
        modalImage.alt = alt;
        caption.innerHTML = `${alt}<br><small>Photo by ${photographer} on Unsplash</small>`;

        modal.classList.add('active');
    }

    function closeImageModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.remove('active');
    }

    // Close modal when clicking outside image
    document.getElementById('imageModal')?.addEventListener('click', (e) => {
        if (e.target === document.getElementById('imageModal')) {
            closeImageModal();
        }
    });

    // Simple notification (you can replace with toast library)
    function showNotification(message, type = 'success') {
        // Simple alert fallback
        alert(message);

        // Optional: Create toast notification
        const toast = document.createElement('div');
        toast.style.position = 'fixed';
        toast.style.bottom = '20px';
        toast.style.right = '20px';
        toast.style.padding = '1rem 1.5rem';
        toast.style.borderRadius = '8px';
        toast.style.color = 'white';
        toast.style.background = type === 'success' ? '#10b981' : '#ef4444';
        toast.style.zIndex = '10000';
        toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 4000);
    }

    // Load initial recommendations on page load (if available)
    document.addEventListener('DOMContentLoaded', () => {
        // If recommendations already loaded from server
        if (window.initialRecommendations) {
            updateAIRecommendations(window.initialRecommendations);
        }
    });
</script>
</body>
</html>